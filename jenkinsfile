pipeline {
  agent any

  environment {
    LOGIN_URL = 'https://api.g66666.hk.my-demo.tech:6443'
    PROJECT = 'user1test'
  }  
  
  stages {
    stage('Login OKD') {
      steps {
        withCredentials(bindings: [usernamePassword(
          		  credentialsId: 'okd-login-api-user', 
          		  usernameVariable: 'USERNAME',
          		  passwordVariable: 'PASSWORD',
          		)]) {
          sh "oc login ${env.LOGIN_URL}  --insecure-skip-tls-verify=true -u $USERNAME -p $PASSWORD"
          sh "oc project $PROJECT"
        }

      }
    }


    stage ('build') {
      steps {
        sh '''
          echo "add your build command here"
        ''' 
      }
    }
    


    stage ('test') {
      steps {
        sh '''
          echo "add your test command here"
        ''' 
      }
    }
  
    stage ('Delete project') {
      steps {
        sh '''
          echo "Delete Project"
        ''' 
        
        sh "if `oc get ns | grep testaa`; then oc delete project testaa"
      }
    } 
  
     stage ('create project') {
      steps {
        sh '''
          echo "Create Project"
        ''' 
        sh "sleep 10"
        sh "oc new-project testaa"
        sh "oc project testaa"
      }
    } 
    
    stage('Deploy') {
      steps {
        echo 'Deploy application'
        script {
          sh 'oc new-app --name openshift-demo \'quay.io/centos7/httpd-24-centos7:latest~https://github.com/wayne-cec/openshift-demo\' --strategy=source --allow-missing-images '
        }

      }
    }
    stage('Expose') {
      steps {
        echo 'Expose Route'
        script {
          sh 'oc expose svc/openshift-demo'
        }

      }
    }
 } 
}
